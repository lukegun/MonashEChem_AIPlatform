BootStrap: debootstrap
OSVersion: bionic
MirrorURL: http://us.archive.ubuntu.com/ubuntu/

%setup
	# General file for the code	
	mkdir -p ${SINGULARITY_ROOTFS}/runcode

	# set up for the MECSIMWRITTER PACKAGE
	mkdir -p ${SINGULARITY_ROOTFS}/runcode/MECWRITER
	cp -R MECWRITTER_V2/*.py ${SINGULARITY_ROOTFS}/runcode/MECWRITER/
	cp MECWRITTER_V2/mecsim.cpython-37m-x86_64-linux-gnu.so ${SINGULARITY_ROOTFS}/runcode/MECWRITER/mecsim.cpython-37m-x86_64-linux-gnu.so
	mkdir -p ${SINGULARITY_ROOTFS}/runcode/MECclustertime
	cp -R MECclustertime/*.py ${SINGULARITY_ROOTFS}/runcode/MECclustertime/
	

%files
    

%runscript
    	# var 1 = what where doing
	# var 2 = Input file
	
	# strips the .txt file from input start	 again shell script should work
	stripinput=$(echo "$filename" |sed -e "s|.txt$||")
	
    	if [ $# -ne 2 ] ; then
       		echo "Please provide an Operation then Input file."
		echo "MECWRITTER..." 
       		exit 1
	fi
	
	# loop for running MECWRITTER
	if [ "$1" = "MECWRITER" ] ; then

		echo "running MECWRITER"
		python3.7 ${SINGULARITY_ROOTFS}/runcode/MECWRITER/Mecsimwritter.py $2 > $stripinput_terminaloutput.txt
    
		echo "finished"

	elif [ "$1" = "CLUSTERTIME" ] ; then
		echo "running CLUSTERTIME"
		python3.7 ${SINGULARITY_ROOTFS}/runcode/MECclustertime/timeseries_cluster.py $2 > $stripinput_terminaloutput.txt

    	fi

	

%labels 
    	AUTHOR Luke Gundry
	MECSim Aurthor: Gareth Kennedy
	
	Currenly set up to run on python 3.7 in unbuntu bionic working in a singulrity Version 3.1 container though higher should work

%post
    
	# install packages and python modules
    apt-get -y --force-yes install vim
    apt-get -y --force-yes update
    apt-get -y --force-yes install build-essential git
    apt-get -y --force-yes install gfortran
    apt-get -y --force-yes install python3.7
    apt-get -y --force-yes install software-properties-common
	apt-get -y --force-yes install bc
    apt-add-repository  universe
    apt-get update
    apt-get -y --force-yes install python3-pip python3.7-dev
# required for sql postgresql
    apt-get -y --force-yes install gcc libpq-dev
    python3.7 -m pip install --upgrade pip
    python3.7 -m pip install pandas numpy scipy seaborn matplotlib
    python3.7 -m pip install psycopg2 psycopg2-binary tslearn
    python3.7 -m pip install h5py
	# stuff for time cluster
	#apt-get -y --force-yes install python3.6
	
	# change permissions of files
    chmod -R 777 ${SINGULARITY_ROOTFS}/runcode

